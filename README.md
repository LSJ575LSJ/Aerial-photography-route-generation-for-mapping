### 项目简介
无人机航拍航线规划系统，支持自定义区域扫描、航线生成、拍照点计算等功能。特别声明，本项目是在https://github.com/zealmap/fly-design?tab=readme-ov-file的基础上完善的，感谢原作者！侵权联系我可删除本项目。

---

### 技术栈

#### 前端
- 框架：Vue 3 + TypeScript
- UI 组件库：Element Plus
- 地图：高德地图 API (AMap)
- 构建工具：Vite
- HTTP 客户端：Axios

#### 后端
- 框架：NestJS + TypeScript
- 运行环境：Node.js
- 日志：NestJS Logger

---

### 核心功能

#### 1. 相机参数计算
- 输入：飞行高度、相机画幅宽度/长度、焦距
- 计算：可拍摄宽度和长度（基于相似三角形原理）
- 公式：`groundWidth = altitude * sensorWidth / focalLength`

#### 2. 航线生成原理

扫描算法：
- 固定使用水平扫描（从下到上）
- 通过角度参数（0-180°）旋转整个坐标系实现任意方向扫描
- 计算每条平行线与多边形的交点

交点分组算法：
- 使用递归/迭代算法动态分组交点对
- `groups[i]` 存储所有平行线的第 i 对交点
- 实现 zigzag 模式：
  - 偶数索引（0, 2, 4...）：顺序插入（从下到上）
  - 奇数索引（1, 3, 5...）：逆序插入（从上到下）

路径构建：
- 按 `groups[0] → groups[1] → groups[2]...` 顺序处理
- 每个 group 内部保持 zigzag 正反切换
- 转场段（平行线之间）不生成拍照点

边距处理：
- 在扫描阶段对每对交点应用边距
- 每个交点沿飞行方向向外扩展边距距离
- 使用大圆距离公式计算方位角和点移动

#### 3. 拍照点生成原理

航向重叠率计算：
- 公式：`拍照间隔 = 相机长度 × (1 - 重叠率)`
- 例如：相机长度 100m，重叠率 70%，则间隔 = 30m

拍照点生成逻辑：
- 沿每条扫描线（平行线）生成拍照点
- 起点必拍：每条扫描线的起点作为第一个拍照点
- 按间隔插点：从起点开始，每隔“拍照间隔”距离生成一个拍照点
- 终点处理：如果下一个理论位置超过终点，则将终点作为最后一个拍照点
- 转场段不拍照：平行线之间的转场段不生成拍照点

#### 4. 旁向重叠率计算
- 公式：`航线间距 = 2 × 相机宽度 / (重叠率 + 1)`
- 用于计算相邻扫描线之间的间距，确保旁向重叠

---

### 项目结构

```
TouXue/
├── frontend/                 # 前端项目
│   ├── src/
│   │   ├── components/
│   │   │   ├── CameraCard.vue          # 相机参数设置卡片
│   │   │   ├── FlightPlanner.vue       # 主地图组件
│   │   │   └── RouteSettingsPanel.vue  # 航线设置面板
│   │   ├── router/                     # 路由配置
│   │   └── utils/                      # 工具函数
│   └── package.json
│
└── backend/                  # 后端项目
    ├── src/
    │   ├── business/
    │   │   └── flight-path/           # 航线生成业务模块
    │   │       ├── flight-path.controller.ts  # 控制器
    │   │       ├── flight-path.service.ts      # 核心算法服务
    │   │       ├── flight-path.interface.ts    # 类型定义
    │   │       └── flight-path.module.ts       # 模块定义
    │   └── main.ts                     # 入口文件
    └── package.json
```

---

### 核心算法流程

1. 多边形标准化：去除 GeoJSON 多边形末尾重复的首点
2. 坐标系旋转：将多边形和点旋转 -angle 度，对齐到水平坐标系
3. 水平扫描：
   - 从下到上生成平行扫描线
   - 计算每条线与多边形的交点
   - 对交点按经度排序
   - 应用边距（左右扩展）
4. 交点分组：使用递归算法将交点对分组到 groups 数组
5. 路径构建：
   - 按 groups 顺序处理
   - 每个 group 内部 zigzag 切换方向
   - 生成 flightPath 和 waypoints
6. 拍照点生成（如果提供拍照间隔）：
   - 遍历每条扫描线
   - 起点必拍，按间隔插点，终点作为最后一点
7. 坐标系还原：将所有点旋转 +angle 度，还原到原始坐标系

---

### 关键特性

- 支持任意角度扫描（0-180°）
- 自动计算航线间距和拍照间隔
- 边距处理：每个交点沿飞行方向扩展
- Zigzag 扫描模式：减少转场时间
- 拍照点与路径分离：便于后续维护和扩展
- 详细日志：便于调试和问题定位

---

### 使用说明

1. 设置相机参数：在右侧 CameraCard 输入参数并点击计算
2. 设置扫描区域：在地图上绘制或输入 GeoJSON
3. 设置航线参数：旁向重叠率、角度、边距等
4. 设置航向重叠率：在 RouteSettingsPanel 中设置，自动计算拍照间隔
5. 生成航线：系统自动调用后端 API 生成航线
6. 可视化：可切换显示航线、航点、拍照点

---

### 技术亮点

- 算法优化：边距计算从路径构建阶段移至扫描阶段，降低复杂度
- 代码简化：移除冗余的垂直扫描代码，统一使用水平扫描+旋转
- 数据结构：拍照点与路径分离，便于维护和扩展
- 用户体验：实时计算、自动刷新、详细错误提示
